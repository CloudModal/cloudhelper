{% load i18n %}
{% load static %}

<div class="alert alert-info help-message" style="margin-left: 0; margin-right: 0;">
    Use access keys to make secure REST or HTTP Query protocol requests to AWS service APIs.
    For your protection, you should never share your secret keys with anyone.
    As a best practice, we recommend frequent key rotation.
    <a href="" target="_blank">{% trans 'Learn more' %} </a>
</div>

<table class="table table-striped table-bordered table-hover m-t-10" id="access_key_list_table" style="width: 100%">
    <thead>
    <tr>
        <th class="text-center">{% trans 'Access key ID' %}</th>
        {#        <th class="text-center">{% trans 'Secret' %}</th>#}
        <th class="text-center">{% trans 'Created' %}</th>
        <th class="text-center">{% trans 'Last used' %}</th>
        <th class="text-center">{% trans 'Status' %}</th>
    </tr>
    </thead>
    <div class="m-t-40">
        <div class="d-flex">
            <div class="mr-auto">
                <div class="form-group">
                    <button id="create-btn" class="btn btn-primary btn-sm">
                        <i class="icon wb-plus" aria-hidden="true"></i>{% trans "Create access key" %}
                    </button>
                </div>
            </div>
            <div class="ml-auto">
                <div class="form-group">
                    <input id="demo-input-search2" type="text" placeholder="Search" autocomplete="off">
                </div>
            </div>
        </div>
    </div>
    <tbody></tbody>
</table>
<script>
    var ak_table = null;

    function initAccessKeyTable() {
        let options = {
            ele: $('#access_key_list_table'),
            columnDefs: [
                {
                    targets: 2, createdCell: function (td, cellData) {
                        let btn = '<button class="btn btn-primary btn-xs btn-secret" data-secret="SECRET">{% trans 'Show' %}</button>';
                        btn = btn.replace("SECRET", cellData);
                        $(td).html(btn)
                    }
                },
                {
                    targets: 3, createdCell: function (td, cellData) {
                        if (cellData) {
                            $(td).html('<i class="fa fa-check text-navy"></i>')
                        } else {
                            $(td).html('<i class="fa fa-times text-danger"></i>')
                        }
                    }
                },
                {
                    targets: 4, createdCell: function (td, cellData) {
                        let date = toSafeLocalDateStr(cellData);
                        $(td).html(date)
                    }
                },
                {
                    targets: 5, createdCell: function (td, cellData, rowData) {
                        let btn = '';
                        let btn_del = '<a class="btn btn-xs btn-danger m-l-xs btn-del" data-id="ID">{% trans "Delete" %}</a>';
                        let btn_inactive = '<a class="btn btn-xs btn-info m-l-xs btn-inactive" data-id="ID">{% trans "Disable" %}</a>';
                        let btn_active = '<a class="btn btn-xs btn-primary m-l-xs btn-active" data-id="ID">{% trans "Enable" %}</a>';

                        btn += btn_del;
                        if (rowData.is_active) {
                            btn += btn_inactive
                        } else {
                            btn += btn_active
                        }
                        btn = btn.replaceAll("ID", cellData);
                        $(td).html(btn);
                    }
                }
            ],
            ajax_url: '{% url "api-auth:access-keys-list" %}',
            columns: [
                {data: "id"},
                {data: "id"},
                {data: "secret"},
                {data: "is_active"},
                {data: "date_created"},
                {data: "id", orderable: false}
            ],
        };
        ak_table = jumpserver.initServerSideDataTable(options);
    }

    $(document).ready(function () {
    }).on("show.bs.modal", "#access_key_modal", function () {
        if (!ak_table) {
            initAccessKeyTable()
        }
    }).on("click", "#create-btn", function () {
        let url = "{% url "api-auth:access-keys-list" %}";
        let data = {
            url: url,
            method: 'POST',
            success: function () {
                ak_table.ajax.reload();
            }
        };
        requestApi(data)
    }).on("click", ".btn-secret", function () {
        let $this = $(this);
        $this.parent().html($this.data("secret"))
    }).on("click", ".btn-del", function () {
        let url = "{% url "api-auth:access-keys-detail" pk=DEFAULT_PK %}";
        url = url.replace("{{ DEFAULT_PK }}", $(this).data("id"));
        objectDelete($(this), $(this).data("id"), url);
    }).on("click", ".btn-active", function () {
        let url = "{% url "api-auth:access-keys-detail" pk=DEFAULT_PK %}";
        url = url.replace("{{ DEFAULT_PK }}", $(this).data("id"));
        let data = {
            url: url,
            body: JSON.stringify({"is_active": true}),
            method: "PATCH",
            success: function () {
                ak_table.ajax.reload();
            }
        };
        requestApi(data)
    }).on("click", ".btn-inactive", function () {
        let url = "{% url "api-auth:access-keys-detail" pk=DEFAULT_PK %}";
        url = url.replace("{{ DEFAULT_PK }}", $(this).data("id"));
        let data = {
            url: url,
            body: JSON.stringify({"is_active": false}),
            method: "PATCH",
            success: function () {
                ak_table.ajax.reload();
            }
        };
        requestApi(data)
    })
</script>
